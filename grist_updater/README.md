# Grist Updater

Сервис для синхронизации данных между Grist и PostgreSQL.

## Общее описание

Grist Updater работает в бесконечном цикле, периодически забирая изменения из Grist и синхронизируя их с локальной базой данных PostgreSQL. Сервис является односторонним (Grist → PostgreSQL), за исключением косвенных изменений через RabbitMQ.

## Цикл работы

### Частота
- **Интервал:** 30 секунд между циклами
- **Перезапуск:** Ежедневно в 00:00 через `restarter` контейнер

### Этапы цикла

1. **Обновление справочников** (`update_utility_data`)
   - Загрузка статусов участия из `Participation_statuses`
   - Загрузка ролей из `Roles`
   - Загрузка типов заездов из `Arrival_type`
   - Синхронизация справочников в PostgreSQL

2. **Синхронизация таблиц** (в порядке зависимостей)
   | Порядок | Таблица Grist | Таблица PostgreSQL | Зависимости |
   |---------|---------------|-------------------|-------------|
   | 1 | `Teams` | `direction` | - |
   | 2 | `People` | `person` | - |
   | 3 | `Participations` | `participation` | People, Teams |
   | 4 | `Badges_2025` | `badge` + `badge_directions` | Teams |
   | 5 | `Arrivals_2025` | `arrival` | - |

### Зависимости

- PostgreSQL с созданными таблицами (через Alembic миграции)
- RabbitMQ для отправки сообщений об удалении/восстановлении
- Доступ к API Grist

## Механизм синхронизации

### Инкрементальная загрузка

- При первом запуске загружаются все записи
- При последующих — только измененные с момента последней синхронизации
- Время последней синхронизации хранится в `sync_state.json`
- Запросы к Grist используют фильтр `updated_at >= last_sync - 300 секунд` (запас на возможные задержки)

### Трансформация данных

Каждая таблица имеет конфигурацию с:
- **field_mapping** — маппинг полей Grist → PostgreSQL
- **transformations** — функции преобразования значений
- **insert_query** — SQL запрос для вставки/обновления
- **dependencies** — зависимости от других таблиц

### Валидация и удаление

При валидации записи:
- Если поле не проходит валидацию → отправляется сообщение в RabbitMQ (`delete_records`)
- Если запись помечена `to_delete` в Grist → отправляется сообщение в RabbitMQ (`delete_records`)
- Если флаг `to_delete` снят → отправляется сообщение (`restore_records`)

## Обработка ошибок

### Retry механизм

- **Цикл синхронизации:** до 3 попыток с экспоненциальным backoff
- **Синхронизация таблицы:** до 5 попыток
- Задержка: `min(300, 2^attempt + random(0,1))` секунд

### Поведение при ошибках

- При неудаче конкретной таблицы — логирование и переход к следующей
- При критической ошибке цикла — ожидание и повторная попытка
- Состояние синхронизации сохраняется только при успешном коммите

## Особенности таблиц

### Badges_2025

Имеет дополнительные запросы:
- **directions** — синхронизация связей бейджа с направлениями (таблица `badge_directions`)
- **parent** — установка родительского бейджа

### Arrivals_2025

- JOIN с таблицей Badges_2025 для получения дополнительных полей валидации
- Проверка существования связанного бейджа

## Файлы

- `grist_updater.py` — основная логика синхронизации
- `run_updater.py` — точка входа, цикл и retry логика
- `config.py` — конфигурация и переменные окружения
- `sync_state.json` — состояние синхронизации (создается автоматически)

## Логирование

- Уровень INFO для основных операций
- Уровень WARNING для RabbitMQ библиотек (уменьшение шума)
- Формат: `YYYY.MM.DD HH:MM:SS [module] [LEVEL]: message`
